<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Realtime System Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
  <!-- Header -->
  <header class="bg-gray-900 p-4 flex justify-between items-center shadow">
    <h2 class="text-2xl font-bold">⚡ Realtime System Dashboard</h2>
    <div id="status" class="text-sm text-gray-400">Connecting...</div>
  </header>

  <!-- Main Grid -->
  <main class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 p-6">

    <!-- System Info -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow col-span-1 md:col-span-2">
      <h3 class="text-lg font-semibold mb-3">System Info</h3>
      <ul class="text-sm grid grid-cols-2 gap-2" id="host-info"></ul>
    </div>

    <!-- CPU -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow">
      <h3 class="text-lg font-semibold mb-2">CPU</h3>
      <div class="w-full bg-gray-700 rounded h-3 overflow-hidden">
        <div id="cpu-bar" class="h-3 bg-green-500"></div>
      </div>
      <p class="mt-1 text-sm">Usage: <span id="cpu-val">--</span>%</p>
      <ul class="mt-2 text-xs space-y-1" id="cpu-extra"></ul>
      <button onclick="location.href='/cpu'"
        class="mt-2 text-xs bg-green-600 hover:bg-green-700 px-2 py-1 rounded-lg">
        See More →
      </button>
    </div>

    <!-- Memory -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow">
      <h3 class="text-lg font-semibold mb-2">Memory</h3>
      <div class="w-full bg-gray-700 rounded h-3 overflow-hidden">
        <div id="mem-bar" class="h-3 bg-blue-500"></div>
      </div>
      <p class="mt-1 text-sm">Usage: <span id="mem-val">--</span>%</p>
      <ul class="mt-2 text-xs space-y-1" id="mem-extra"></ul>
      <button onclick="location.href='/mem'"
        class="mt-2 text-xs bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded-lg">
        See More →
      </button>
    </div>

    <!-- Swap -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow">
      <h3 class="text-lg font-semibold mb-2">Swap</h3>
      <div class="w-full bg-gray-700 rounded h-3 overflow-hidden">
        <div id="swap-bar" class="h-3 bg-purple-500"></div>
      </div>
      <p class="mt-1 text-sm">Usage: <span id="swap-val">--</span>%</p>
      <ul class="mt-2 text-xs space-y-1" id="swap-extra"></ul>
    </div>

    <!-- Disk -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow col-span-1 xl:col-span-2">
      <h3 class="text-lg font-semibold mb-3">Disks</h3>
      <table class="w-full text-xs border border-gray-700 rounded overflow-hidden">
        <thead class="bg-gray-700 text-gray-300">
          <tr><th class="p-2">Device</th><th>Mount</th><th>FS</th><th>Used %</th></tr>
        </thead>
        <tbody id="disk-table"></tbody>
      </table>
      <p class="mt-3 text-sm text-gray-400">IO: <span id="disk-io"></span></p>
    </div>

    <!-- Network -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow col-span-1 xl:col-span-2">
      <h3 class="text-lg font-semibold mb-3">Network</h3>
      <p class="text-sm">Sent: <span id="net-sent">--</span> KB | Recv: <span id="net-recv">--</span> KB</p>
      <div class="grid grid-cols-2 gap-4 mt-3">
        <div>
          <h4 class="font-semibold text-sm mb-1">Interfaces</h4>
          <ul id="net-interfaces" class="text-xs space-y-1"></ul>
        </div>
        <div>
          <h4 class="font-semibold text-sm mb-1">Stats</h4>
          <ul id="net-stats" class="text-xs space-y-1"></ul>
        </div>
      </div>
      <button onclick="location.href='/net'"
        class="mt-3 text-xs bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded-lg">
        See More →
      </button>
    </div>

    <!-- Battery -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow">
      <h3 class="text-lg font-semibold mb-2">Battery</h3>
      <ul id="battery" class="text-sm space-y-1"></ul>
    </div>

    <!-- Processes -->
    <div class="bg-gray-800 rounded-2xl p-4 shadow col-span-1 xl:col-span-3">
      <h3 class="text-lg font-semibold mb-3">Processes</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h4 class="text-sm font-semibold mb-1">Top CPU</h4>
          <table class="w-full text-xs border border-gray-700 rounded overflow-hidden">
            <thead class="bg-gray-700 text-gray-300">
              <tr><th class="p-2">PID</th><th>Name</th><th>User</th><th>CPU %</th><th>Mem %</th></tr>
            </thead>
            <tbody id="proc-cpu"></tbody>
          </table>
        </div>
        <div>
          <h4 class="text-sm font-semibold mb-1">Top Memory</h4>
          <table class="w-full text-xs border border-gray-700 rounded overflow-hidden">
            <thead class="bg-gray-700 text-gray-300">
              <tr><th class="p-2">PID</th><th>Name</th><th>User</th><th>CPU %</th><th>Mem %</th></tr>
            </thead>
            <tbody id="proc-mem"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-400 text-xs text-center p-2">
    Boot Time: <span id="boot-time">--</span> | 
    Users: <span id="users">--</span> | 
    Last updated: <span id="timestamp">--</span>
  </footer>

  <script>
    const cpuBar = document.getElementById('cpu-bar');
    const memBar = document.getElementById('mem-bar');
    const swapBar = document.getElementById('swap-bar');

    const hostInfo = document.getElementById('host-info');
    const cpuExtra = document.getElementById('cpu-extra');
    const memExtra = document.getElementById('mem-extra');
    const swapExtra = document.getElementById('swap-extra');
    const diskTable = document.getElementById('disk-table');
    const diskIO = document.getElementById('disk-io');
    const netInterfaces = document.getElementById('net-interfaces');
    const netStats = document.getElementById('net-stats');
    const netSent = document.getElementById('net-sent');
    const netRecv = document.getElementById('net-recv');
    const battery = document.getElementById('battery');
    const procCPU = document.getElementById('proc-cpu');
    const procMem = document.getElementById('proc-mem');
    const bootTime = document.getElementById('boot-time');
    const users = document.getElementById('users');
    const timestamp = document.getElementById('timestamp');
    const statusEl = document.getElementById('status');

    const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://${location.host}/ws?role=dashboard`;
    const ws = new WebSocket(wsUrl);

    ws.onopen = () => statusEl.textContent = "✅ Connected";
    ws.onclose = () => statusEl.textContent = "❌ Disconnected";
    ws.onerror = () => statusEl.textContent = "⚠️ Error";

    ws.onmessage = (evt) => {
      try {
        const data = JSON.parse(evt.data);

        // Host
        hostInfo.innerHTML = `
          <li>System: ${data.Host.system}</li>
          <li>Platform: ${data.Host.platform}</li>
          <li>Release: ${data.Host.release}</li>
          <li>Python: ${data.Host.python_version}</li>
          <li>Hostname: ${data.Host.hostname}</li>
        `;

        // CPU
        cpuBar.style.width = data.CPU.cpu_percent + "%";
        document.getElementById('cpu-val').textContent = data.CPU.cpu_percent.toFixed(1);
        cpuExtra.innerHTML = `<li>Logical: ${data.CPU.cpu_count_logical}, Physical: ${data.CPU.cpu_count_physical}</li>`;

        // Memory
        memBar.style.width = data["Virtual Memory"].percent + "%";
        document.getElementById('mem-val').textContent = data["Virtual Memory"].percent;
        memExtra.innerHTML = `<li>Total: ${(data["Virtual Memory"].total/1e9).toFixed(1)} GB</li>
                              <li>Available: ${(data["Virtual Memory"].available/1e9).toFixed(1)} GB</li>`;

        // Swap
        swapBar.style.width = data["Swap Memory"].percent + "%";
        document.getElementById('swap-val').textContent = data["Swap Memory"].percent;
        swapExtra.innerHTML = `<li>Total: ${(data["Swap Memory"].total/1e9).toFixed(1)} GB</li>
                               <li>Used: ${(data["Swap Memory"].used/1e9).toFixed(1)} GB</li>`;

        // Disk
        diskTable.innerHTML = "";
        data["Disk Partitions"].forEach(d => {
          diskTable.innerHTML += `<tr class="border-t border-gray-700">
            <td class="p-1">${d.device}</td><td>${d.mountpoint}</td><td>${d.fstype}</td><td>${d.usage.percent}%</td>
          </tr>`;
        });
        diskIO.textContent = `Reads: ${data["Disk IO Counters"].read_count}, Writes: ${data["Disk IO Counters"].write_count}`;

        // Network
        netSent.textContent = (data["Network IO Counters"].bytes_sent/1024).toFixed(2);
        netRecv.textContent = (data["Network IO Counters"].bytes_recv/1024).toFixed(2);

        netInterfaces.innerHTML = "";
        for (const [iface, addrs] of Object.entries(data["Network Interfaces"])) {
          netInterfaces.innerHTML += `<li>${iface}: ${addrs.map(a=>a.address).join(", ")}</li>`;
        }

        netStats.innerHTML = "";
        for (const [iface, st] of Object.entries(data["Network Stats"])) {
          netStats.innerHTML += `<li>${iface}: up=${st.isup}, speed=${st.speed}Mb</li>`;
        }

        // Battery
        battery.innerHTML = `<li>Percent: ${data.Battery.percent}%</li>
                             <li>Plugged: ${data.Battery.power_plugged}</li>`;

        // Processes
        procCPU.innerHTML = "";
        data["Top CPU Processes"].forEach(p => {
          procCPU.innerHTML += `<tr class="border-t border-gray-700">
            <td class="p-1">${p.pid}</td><td>${p.name}</td><td>${p.username}</td>
            <td>${p.cpu_percent}</td><td>${p.memory_percent.toFixed(2)}</td></tr>`;
        });

        procMem.innerHTML = "";
        data["Top Memory Processes"].forEach(p => {
          procMem.innerHTML += `<tr class="border-t border-gray-700">
            <td class="p-1">${p.pid}</td><td>${p.name}</td><td>${p.username}</td>
            <td>${p.cpu_percent}</td><td>${p.memory_percent.toFixed(2)}</td></tr>`;
        });

        // Footer
        bootTime.textContent = data["Boot Time"];
        users.textContent = data.Users.length ? JSON.stringify(data.Users) : "None";
        timestamp.textContent = data.Timestamp;

      } catch(e) { console.error(e); }
    }
  </script>
</body>
</html>
