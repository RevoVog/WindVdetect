<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Realtime System Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header>
    <h2>⚡ Realtime System Dashboard</h2>
    <div id="status">Connecting...</div>
  </header>

  <main class="grid">
    <!-- System Info -->
    <div class="card wide">
      <h3>System Info</h3>
      <pre id="host-info">--</pre>
    </div>

    <!-- CPU -->
    <div class="card">
      <h3>CPU Usage</h3>
      <div class="progress-bar"><div id="cpu-bar"></div></div>
      <p><span id="cpu-val">--</span>%</p>
      <pre id="cpu-stats">--</pre>
    </div>

    <!-- Memory -->
    <div class="card">
      <h3>Memory Usage</h3>
      <div class="progress-bar"><div id="mem-bar"></div></div>
      <p><span id="mem-val">--</span>%</p>
      <pre id="mem-stats">--</pre>
    </div>

    <!-- Swap -->
    <div class="card">
      <h3>Swap Usage</h3>
      <div class="progress-bar"><div id="swap-bar"></div></div>
      <p><span id="swap-val">--</span>%</p>
      <pre id="swap-stats">--</pre>
    </div>

    <!-- Disk -->
    <div class="card wide">
      <h3>Disk Partitions</h3>
      <table>
        <thead>
          <tr><th>Device</th><th>Mount</th><th>FS</th><th>Used %</th></tr>
        </thead>
        <tbody id="disk-table"></tbody>
      </table>
      <h4>Disk IO Counters</h4>
      <pre id="disk-io">--</pre>
    </div>

    <!-- Network -->
    <div class="card wide">
      <h3>Network Interfaces</h3>
      <pre id="net-interfaces">--</pre>

      <h4>Network Stats</h4>
      <pre id="net-stats">--</pre>

      <h4>Network IO Counters</h4>
      <p>Sent: <span id="net-sent">--</span> KB | Recv: <span id="net-recv">--</span> KB</p>
    </div>

    <!-- Battery -->
    <div class="card">
      <h3>Battery</h3>
      <pre id="battery">--</pre>
    </div>

    <!-- Processes -->
    <div class="card wide">
      <h3>Top CPU Processes</h3>
      <table>
        <thead>
          <tr><th>PID</th><th>Name</th><th>User</th><th>CPU %</th><th>Mem %</th></tr>
        </thead>
        <tbody id="proc-cpu"></tbody>
      </table>

      <h3>Top Memory Processes</h3>
      <table>
        <thead>
          <tr><th>PID</th><th>Name</th><th>User</th><th>CPU %</th><th>Mem %</th></tr>
        </thead>
        <tbody id="proc-mem"></tbody>
      </table>
    </div>
  </main>

  <footer>
    <small>
      Boot Time: <span id="boot-time">--</span> | 
      Users: <span id="users">--</span> | 
      Last updated: <span id="timestamp">--</span>
    </small>
  </footer>

  <script>
    const statusEl = document.getElementById('status');

    const cpuBar = document.getElementById('cpu-bar');
    const memBar = document.getElementById('mem-bar');
    const swapBar = document.getElementById('swap-bar');

    const cpuVal = document.getElementById('cpu-val');
    const memVal = document.getElementById('mem-val');
    const swapVal = document.getElementById('swap-val');

    const hostInfo = document.getElementById('host-info');
    const cpuStats = document.getElementById('cpu-stats');
    const memStats = document.getElementById('mem-stats');
    const swapStats = document.getElementById('swap-stats');

    const diskTable = document.getElementById('disk-table');
    const diskIO = document.getElementById('disk-io');

    const netInterfaces = document.getElementById('net-interfaces');
    const netStats = document.getElementById('net-stats');
    const netSent = document.getElementById('net-sent');
    const netRecv = document.getElementById('net-recv');

    const battery = document.getElementById('battery');

    const procCPU = document.getElementById('proc-cpu');
    const procMem = document.getElementById('proc-mem');

    const bootTime = document.getElementById('boot-time');
    const users = document.getElementById('users');
    const timestamp = document.getElementById('timestamp');

    const protocol = (location.protocol === "https:") ? "wss" : "ws";
    const wsUrl = `${protocol}://${location.host}/ws?role=dashboard`;
    const ws = new WebSocket(wsUrl);

    ws.onopen = () => { statusEl.textContent = "✅ Connected"; };
    ws.onclose = () => { statusEl.textContent = "❌ Disconnected"; };
    ws.onerror = () => { statusEl.textContent = "⚠️ WebSocket error"; };

    ws.onmessage = (evt) => {
      try {
        const data = JSON.parse(evt.data);

        // Host info
        hostInfo.textContent = JSON.stringify(data.Host, null, 2);

        // CPU
        cpuVal.textContent = data.CPU.cpu_percent.toFixed(1);
        cpuBar.style.width = data.CPU.cpu_percent + "%";
        cpuStats.textContent = JSON.stringify({times: data.CPU.cpu_times, stats: data.CPU.cpu_stats}, null, 2);

        // Memory
        memVal.textContent = data["Virtual Memory"].percent;
        memBar.style.width = data["Virtual Memory"].percent + "%";
        memStats.textContent = JSON.stringify(data["Virtual Memory"], null, 2);

        // Swap
        swapVal.textContent = data["Swap Memory"].percent;
        swapBar.style.width = data["Swap Memory"].percent + "%";
        swapStats.textContent = JSON.stringify(data["Swap Memory"], null, 2);

        // Disks
        diskTable.innerHTML = "";
        data["Disk Partitions"].forEach(d => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${d.device}</td><td>${d.mountpoint}</td><td>${d.fstype}</td><td>${d.usage.percent}%</td>`;
          diskTable.appendChild(tr);
        });
        diskIO.textContent = JSON.stringify(data["Disk IO Counters"], null, 2);

        // Network
        netInterfaces.textContent = JSON.stringify(data["Network Interfaces"], null, 2);
        netStats.textContent = JSON.stringify(data["Network Stats"], null, 2);
        netSent.textContent = (data["Network IO Counters"].bytes_sent / 1024).toFixed(2);
        netRecv.textContent = (data["Network IO Counters"].bytes_recv / 1024).toFixed(2);

        // Battery
        battery.textContent = JSON.stringify(data.Battery, null, 2);

        // Processes
        procCPU.innerHTML = "";
        data["Top CPU Processes"].forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${p.pid}</td><td>${p.name}</td><td>${p.username}</td><td>${p.cpu_percent}</td><td>${p.memory_percent.toFixed(2)}</td>`;
          procCPU.appendChild(tr);
        });

        procMem.innerHTML = "";
        data["Top Memory Processes"].forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${p.pid}</td><td>${p.name}</td><td>${p.username}</td><td>${p.cpu_percent}</td><td>${p.memory_percent.toFixed(2)}</td>`;
          procMem.appendChild(tr);
        });

        // Footer info
        bootTime.textContent = data["Boot Time"];
        users.textContent = JSON.stringify(data.Users);
        timestamp.textContent = data.Timestamp;

      } catch (err) {
        console.error("Parse error", err);
      }
    };
  </script>
</body>
</html>
